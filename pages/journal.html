<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal de Trading - Astral Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e5e5e5;
            min-height: 100vh;
        }
        
        .card {
            background-color: #171717;
            border: 1px solid #2d2d2d;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: #3b82f6;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #262626;
            color: #e5e5e5;
            border: 1px solid #404040;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: #1e1e1e;
            border-color: #525252;
        }
        
        .input-field {
            background-color: #262626;
            border: 1px solid #404040;
            color: #e5e5e5;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .profit {
            color: #10b981;
        }
        
        .loss {
            color: #ef4444;
        }
        
        .nav-link {
            color: #a3a3a3;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            color: #e5e5e5;
        }
        
        .nav-link.active {
            color: #3b82f6;
        }
        
        .balance-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .divider {
            border-color: #2d2d2d;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navbar -->
    <nav class="bg-black border-b border-gray-800 fixed w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-white font-bold text-xl">Astral Trading</span>
                    </div>
                    <div class="hidden md:block ml-10">
                        <div class="flex space-x-8">
                            <a href="/" class="nav-link px-3 py-2 text-sm font-medium">
                                <i class="fas fa-home mr-2"></i> Accueil
                            </a>
                            <a href="#" class="nav-link active px-3 py-2 text-sm font-medium">
                                <i class="fas fa-book mr-2"></i> Journal
                            </a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <button id="logoutButton" class="btn-secondary flex items-center text-sm font-medium px-4 py-2 rounded-md">
                            <i class="fas fa-sign-out-alt mr-2"></i> Déconnexion
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-white mb-2">
                Journal de Trading
            </h1>
            <p class="text-gray-400 max-w-2xl mx-auto">
                Suivez vos performances et analysez vos transactions
            </p>
        </div>

        <!-- User Info -->
        <div id="loginStatus" class="card p-4 mb-8 text-center" style="display: none;">
            <p class="text-gray-300">
                Connecté en tant que : <span id="userName" class="font-medium text-white"></span>
            </p>
        </div>

        <!-- Balance Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Balance Card -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white">
                        <i class="fas fa-wallet mr-2"></i> Solde actuel
                    </h2>
                    <button id="refreshBalance" class="text-gray-400 hover:text-white">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="text-center py-4">
                    <p class="text-gray-400 mb-1">Votre solde disponible</p>
                    <div class="balance-display" id="balance">0.00</div>
                    <p class="text-gray-400 mt-2">€</p>
                </div>
            </div>

            <!-- Transaction Form -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-exchange-alt mr-2"></i> Nouvelle transaction
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="balanceChange" class="block text-sm font-medium text-gray-300 mb-1">Montant (€)</label>
                        <input type="number" step="0.01" id="balanceChange" placeholder="Entrez le montant" 
                               class="input-field w-full px-4 py-3 rounded-lg focus:outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="addBalanceButton" class="btn-primary w-full font-medium py-3 px-4 rounded-lg">
                            <i class="fas fa-plus-circle mr-2"></i> Ajouter
                        </button>
                        <button id="subtractBalanceButton" class="btn-secondary w-full font-medium py-3 px-4 rounded-lg">
                            <i class="fas fa-minus-circle mr-2"></i> Soustraire
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="card p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-white">
                    <i class="fas fa-history mr-2"></i> Historique des transactions
                </h2>
                <div class="text-sm text-gray-400">
                    <span id="transactionCount">0</span> transactions
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-800">
                    <thead class="bg-gray-900">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Montant
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Date & Heure
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Type
                            </th>
                        </tr>
                    </thead>
                    <tbody id="historyTable" class="divide-y divide-gray-800">
                        <!-- Transactions will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex items-center justify-between mt-6">
                <button id="pagePrevious" class="btn-secondary flex items-center text-sm font-medium px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-chevron-left mr-2"></i> Précédent
                </button>
                <span class="text-sm text-gray-400">Page <span id="currentPage">1</span></span>
                <button id="pageNext" class="btn-secondary flex items-center text-sm font-medium px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                    Suivant <i class="fas fa-chevron-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-900/20 text-blue-400 mr-4">
                        <i class="fas fa-arrow-up text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Gains totaux</p>
                        <p class="text-2xl font-semibold text-white" id="totalProfit">0.00 €</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-900/20 text-red-400 mr-4">
                        <i class="fas fa-arrow-down text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Pertes totales</p>
                        <p class="text-2xl font-semibold text-white" id="totalLoss">0.00 €</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-gray-800 text-blue-400 mr-4">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Balance nette</p>
                        <p class="text-2xl font-semibold text-white" id="netBalance">0.00 €</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBOks3pghhiGNRtTSDSPiIzGs1JgfUZz5M",
            authDomain: "astral-trading.firebaseapp.com",
            projectId: "astral-trading",
            storageBucket: "astral-trading.appspot.com",
            messagingSenderId: "269125744623",
            appId: "1:269125744623:web:8060af03ecc845a62a681a"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Elements DOM
        const balanceChange = document.getElementById("balanceChange");
        const addBalanceButton = document.getElementById("addBalanceButton");
        const subtractBalanceButton = document.getElementById("subtractBalanceButton");
        const refreshBalance = document.getElementById("refreshBalance");
        const balanceElement = document.getElementById("balance");
        const logoutButton = document.getElementById("logoutButton");
        const historyTable = document.getElementById("historyTable");
        const pagePrevious = document.getElementById("pagePrevious");
        const pageNext = document.getElementById("pageNext");
        const currentPageElement = document.getElementById("currentPage");
        const transactionCountElement = document.getElementById("transactionCount");
        const totalProfitElement = document.getElementById("totalProfit");
        const totalLossElement = document.getElementById("totalLoss");
        const netBalanceElement = document.getElementById("netBalance");
        const userNameElement = document.getElementById("userName");
        const loginStatusElement = document.getElementById("loginStatus");

        // Variables d'état
        let userId = null;
        let currentPage = 1;
        const pageSize = 10;
        let lastVisible = null;
        let firstVisible = null;
        let totalTransactions = 0;

        // Écouteur d'état d'authentification
        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                userNameElement.textContent = user.email;
                loginStatusElement.style.display = "block";
                loadBalance(userId);
                loadTransactionHistory(userId);
                calculateStats(userId);
            } else {
                window.location.href = '/';
            }
        });

        // Charger le solde
        const loadBalance = (userId) => {
            db.collection("journals").doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const balance = doc.data().balance || 0;
                        balanceElement.textContent = balance.toFixed(2);
                        netBalanceElement.textContent = balance.toFixed(2) + " €";
                    }
                })
                .catch(error => {
                    console.error("Erreur de chargement du solde:", error);
                });
        };

        // Charger l'historique des transactions
        const loadTransactionHistory = (userId) => {
            let query = db.collection("journals").doc(userId)
                          .collection("transactions")
                          .orderBy("timestamp", "desc")
                          .limit(pageSize);
            
            if (currentPage > 1 && lastVisible) {
                query = query.startAfter(lastVisible);
            }

            query.get()
                .then(querySnapshot => {
                    historyTable.innerHTML = "";
                    
                    if (querySnapshot.size > 0) {
                        lastVisible = querySnapshot.docs[querySnapshot.docs.length-1];
                        firstVisible = querySnapshot.docs[0];
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const row = document.createElement("tr");
                            row.className = "hover:bg-gray-800/50 transition-colors";
                            
                            // Cellule Montant
                            const amountCell = document.createElement("td");
                            amountCell.className = `px-6 py-4 whitespace-nowrap text-sm font-medium ${data.amount >= 0 ? 'profit' : 'loss'}`;
                            amountCell.textContent = `${data.amount >= 0 ? '+' : ''}${data.amount.toFixed(2)} €`;
                            
                            // Cellule Date
                            const timeCell = document.createElement("td");
                            timeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                            timeCell.textContent = new Date(data.timestamp.seconds * 1000).toLocaleString();
                            
                            // Cellule Type
                            const typeCell = document.createElement("td");
                            typeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                            typeCell.textContent = data.amount >= 0 ? "Gain" : "Perte";
                            
                            row.appendChild(amountCell);
                            row.appendChild(timeCell);
                            row.appendChild(typeCell);
                            
                            historyTable.appendChild(row);
                        });
                    } else {
                        // Aucune transaction
                        const row = document.createElement("tr");
                        const cell = document.createElement("td");
                        cell.colSpan = 3;
                        cell.className = "px-6 py-4 text-center text-sm text-gray-400";
                        cell.textContent = "Aucune transaction enregistrée";
                        row.appendChild(cell);
                        historyTable.appendChild(row);
                    }
                    
                    // Mettre à jour la pagination
                    pageNext.disabled = querySnapshot.size < pageSize;
                    pagePrevious.disabled = currentPage <= 1;
                    currentPageElement.textContent = currentPage;
                    
                    // Compter le nombre total de transactions
                    db.collection("journals").doc(userId).collection("transactions").get()
                        .then(snap => {
                            totalTransactions = snap.size;
                            transactionCountElement.textContent = totalTransactions;
                        });
                })
                .catch(error => {
                    console.error("Erreur de chargement de l'historique:", error);
                });
        };

        // Calculer les statistiques
        const calculateStats = (userId) => {
            const transactionsRef = db.collection("journals").doc(userId).collection("transactions");
            
            // Calcul des gains
            transactionsRef.where("amount", ">", 0).get()
                .then(querySnapshot => {
                    let totalProfit = 0;
                    querySnapshot.forEach(doc => {
                        totalProfit += doc.data().amount;
                    });
                    totalProfitElement.textContent = totalProfit.toFixed(2) + " €";
                });
            
            // Calcul des pertes
            transactionsRef.where("amount", "<", 0).get()
                .then(querySnapshot => {
                    let totalLoss = 0;
                    querySnapshot.forEach(doc => {
                        totalLoss += doc.data().amount;
                    });
                    totalLossElement.textContent = Math.abs(totalLoss).toFixed(2) + " €";
                });
        };

        // Ajouter du solde
        addBalanceButton.addEventListener("click", () => {
            const amount = parseFloat(balanceChange.value);
            if (isNaN(amount) || amount <= 0) {
                alert("Veuillez entrer un montant valide positif.");
                return;
            }
            processTransaction(amount);
        });

        // Soustraire du solde
        subtractBalanceButton.addEventListener("click", () => {
            const amount = parseFloat(balanceChange.value);
            if (isNaN(amount) || amount <= 0) {
                alert("Veuillez entrer un montant valide positif.");
                return;
            }
            processTransaction(-amount);
        });

        // Traiter une transaction
        const processTransaction = (amount) => {
            const userRef = db.collection("journals").doc(userId);
            
            db.runTransaction(transaction => {
                return transaction.get(userRef).then(doc => {
                    let newBalance = 0;
                    if (doc.exists) {
                        newBalance = doc.data().balance || 0;
                    }
                    newBalance += amount;

                    // Mettre à jour le solde
                    transaction.set(userRef, { balance: newBalance }, { merge: true });

                    // Ajouter la transaction à l'historique
                    const transactionRef = userRef.collection("transactions").doc();
                    transaction.set(transactionRef, {
                        amount: amount,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    return newBalance;
                });
            })
            .then(newBalance => {
                // Mettre à jour l'interface
                balanceElement.textContent = newBalance.toFixed(2);
                netBalanceElement.textContent = newBalance.toFixed(2) + " €";
                balanceChange.value = "";
                
                // Recharger les données
                loadTransactionHistory(userId);
                calculateStats(userId);
            })
            .catch(error => {
                console.error("Erreur de transaction:", error);
                alert("Une erreur s'est produite lors de la mise à jour du solde.");
            });
        };

        // Rafraîchir les données
        refreshBalance.addEventListener("click", () => {
            loadBalance(userId);
            loadTransactionHistory(userId);
            calculateStats(userId);
        });

        // Pagination
        pageNext.addEventListener("click", () => {
            currentPage++;
            loadTransactionHistory(userId);
        });

        pagePrevious.addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                loadTransactionHistory(userId);
            }
        });

        // Déconnexion
        logoutButton.addEventListener("click", () => {
            auth.signOut()
                .then(() => {
                    window.location.href = '/';
                })
                .catch(error => {
                    console.error("Erreur de déconnexion:", error);
                });
        });
    </script>
</body>
</html>