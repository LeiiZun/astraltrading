<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal de Trading - Astral Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border-radius: 12px;
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .neon-border {
            position: relative;
        }
        
        .neon-border::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 1px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        .glow-effect {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        
        .glow-effect:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
        }
        
        .transaction-positive {
            color: #10b981;
        }
        
        .transaction-negative {
            color: #ef4444;
        }
        
        .pagination-btn {
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover {
            transform: translateY(-2px);
        }
        
        .balance-display {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        
        .input-field {
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navbar -->
    <nav class="glass-card fixed w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-white font-bold text-xl gradient-text">Astral Trading</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                                <i class="fas fa-home mr-1"></i> Accueil
                            </a>
                            <a href="#" class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-book mr-1"></i> Journal
                            </a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <button id="logoutButton" class="flex items-center text-sm font-medium text-gray-300 hover:text-white bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i> Déconnexion
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-white mb-2">
                <span class="gradient-text">Journal de Trading</span>
            </h1>
            <p class="text-gray-400 max-w-2xl mx-auto">
                Suivez vos performances et analysez vos transactions pour améliorer votre stratégie
            </p>
        </div>

        <!-- User Info -->
        <div id="loginStatus" class="glass-card p-4 mb-8 text-center" style="display: none;">
            <p class="text-gray-300">
                Connecté en tant que : <span id="userName" class="font-medium text-white"></span>
            </p>
        </div>

        <!-- Balance Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Balance Card -->
            <div class="glass-card neon-border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white">
                        <i class="fas fa-wallet mr-2"></i> Solde actuel
                    </h2>
                    <div class="text-gray-400">
                        <i class="fas fa-sync-alt cursor-pointer hover:text-white transition-colors" id="refreshBalance"></i>
                    </div>
                </div>
                <div class="text-center py-4">
                    <p class="text-gray-400 mb-1">Votre solde disponible</p>
                    <div class="balance-display gradient-text" id="balance">0.00</div>
                    <p class="text-gray-400 mt-2">€</p>
                </div>
            </div>

            <!-- Transaction Form -->
            <div class="glass-card neon-border p-6">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-exchange-alt mr-2"></i> Nouvelle transaction
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="balanceChange" class="block text-sm font-medium text-gray-300 mb-1">Montant</label>
                        <input type="number" id="balanceChange" placeholder="Entrez un montant positif ou négatif" 
                               class="input-field w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="updateBalanceButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors glow-effect">
                            <i class="fas fa-plus-circle mr-2"></i> Ajouter
                        </button>
                        <button id="subtractBalanceButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-colors glow-effect">
                            <i class="fas fa-minus-circle mr-2"></i> Soustraire
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="glass-card neon-border p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-white">
                    <i class="fas fa-history mr-2"></i> Historique des transactions
                </h2>
                <div class="text-sm text-gray-400">
                    <span id="transactionCount">0</span> transactions
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Montant
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Date & Heure
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Type
                            </th>
                        </tr>
                    </thead>
                    <tbody id="historyTable" class="bg-gray-900 divide-y divide-gray-700">
                        <!-- Transactions will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex items-center justify-between mt-6">
                <button id="pagePrevious" class="pagination-btn flex items-center text-sm font-medium text-gray-300 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-chevron-left mr-2"></i> Précédent
                </button>
                <span class="text-sm text-gray-400">Page <span id="currentPage">1</span></span>
                <button id="pageNext" class="pagination-btn flex items-center text-sm font-medium text-gray-300 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Suivant <i class="fas fa-chevron-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-card neon-border p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-900/30 text-blue-400 mr-4">
                        <i class="fas fa-arrow-up text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Gains totaux</p>
                        <p class="text-2xl font-semibold text-white" id="totalProfit">0.00 €</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-card neon-border p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-900/30 text-red-400 mr-4">
                        <i class="fas fa-arrow-down text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Pertes totales</p>
                        <p class="text-2xl font-semibold text-white" id="totalLoss">0.00 €</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-card neon-border p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-900/30 text-purple-400 mr-4">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Balance nette</p>
                        <p class="text-2xl font-semibold text-white" id="netBalance">0.00 €</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOks3pghhiGNRtTSDSPiIzGs1JgfUZz5M",
            authDomain: "astral-trading.firebaseapp.com",
            projectId: "astral-trading",
            storageBucket: "astral-trading.appspot.com",
            messagingSenderId: "269125744623",
            appId: "1:269125744623:web:8060af03ecc845a62a681a"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Elements
        const balanceChange = document.getElementById("balanceChange");
        const updateBalanceButton = document.getElementById("updateBalanceButton");
        const subtractBalanceButton = document.getElementById("subtractBalanceButton");
        const refreshBalance = document.getElementById("refreshBalance");
        const balanceElement = document.getElementById("balance");
        const logoutButton = document.getElementById("logoutButton");
        const historyTable = document.getElementById("historyTable");
        const pagePrevious = document.getElementById("pagePrevious");
        const pageNext = document.getElementById("pageNext");
        const currentPageElement = document.getElementById("currentPage");
        const transactionCountElement = document.getElementById("transactionCount");
        const totalProfitElement = document.getElementById("totalProfit");
        const totalLossElement = document.getElementById("totalLoss");
        const netBalanceElement = document.getElementById("netBalance");
        const userNameElement = document.getElementById("userName");
        const loginStatusElement = document.getElementById("loginStatus");

        let userId = null;
        let currentPage = 1;
        const pageSize = 10;
        let lastVisible = null;
        let firstVisible = null;
        let totalTransactions = 0;

        // Vérifier si un utilisateur est connecté
        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                userNameElement.textContent = user.email;
                loginStatusElement.style.display = "block";
                loadBalance(userId);
                loadTransactionHistory(userId);
                calculateStats(userId);
                logoutButton.style.display = "flex";
            } else {
                window.location.href = '/';
            }
        });

        // Fonction pour charger le solde depuis Firestore
        const loadBalance = (userId) => {
            const userRef = db.collection("journals").doc(userId);
            userRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const balance = data.balance || 0.00;
                    balanceElement.textContent = balance.toFixed(2);
                } else {
                    balanceElement.textContent = "0.00";
                }
            }).catch(error => {
                console.error("Erreur de chargement du solde :", error);
            });
        };

        // Fonction pour charger l'historique des transactions
        const loadTransactionHistory = (userId) => {
            let query = db.collection("journals").doc(userId)
                          .collection("transactions")
                          .orderBy("timestamp", "desc")
                          .limit(pageSize);
            
            if (currentPage > 1 && lastVisible) {
                query = query.startAfter(lastVisible);
            }

            query.get().then(querySnapshot => {
                historyTable.innerHTML = "";
                
                if (querySnapshot.size > 0) {
                    lastVisible = querySnapshot.docs[querySnapshot.docs.length-1];
                    firstVisible = querySnapshot.docs[0];
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement("tr");
                        row.className = "hover:bg-gray-800/50 transition-colors";
                        
                        const amountCell = document.createElement("td");
                        amountCell.className = `px-6 py-4 whitespace-nowrap text-sm font-medium ${data.amount >= 0 ? 'transaction-positive' : 'transaction-negative'}`;
                        amountCell.textContent = `${data.amount >= 0 ? '+' : ''}${data.amount.toFixed(2)} €`;
                        
                        const timeCell = document.createElement("td");
                        timeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                        timeCell.textContent = new Date(data.timestamp.seconds * 1000).toLocaleString();
                        
                        const typeCell = document.createElement("td");
                        typeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                        typeCell.textContent = data.amount >= 0 ? "Gain" : "Perte";
                        
                        row.appendChild(amountCell);
                        row.appendChild(timeCell);
                        row.appendChild(typeCell);
                        
                        historyTable.appendChild(row);
                    });
                }
                
                // Update pagination controls
                pageNext.disabled = querySnapshot.size < pageSize;
                pagePrevious.disabled = currentPage <= 1;
                currentPageElement.textContent = currentPage;
                
                // Count total transactions (simplified - in production you'd want a more efficient way)
                db.collection("journals").doc(userId).collection("transactions").get()
                  .then(snap => {
                      totalTransactions = snap.size;
                      transactionCountElement.textContent = totalTransactions;
                  });
            }).catch(error => {
                console.error("Erreur de chargement de l'historique :", error);
            });
        };

        // Fonction pour calculer les statistiques
        const calculateStats = (userId) => {
            const transactionsRef = db.collection("journals").doc(userId).collection("transactions");
            
            // Calculate profit
            transactionsRef.where("amount", ">", 0).get().then(querySnapshot => {
                let totalProfit = 0;
                querySnapshot.forEach(doc => {
                    totalProfit += doc.data().amount;
                });
                totalProfitElement.textContent = totalProfit.toFixed(2) + " €";
            });
            
            // Calculate loss
            transactionsRef.where("amount", "<", 0).get().then(querySnapshot => {
                let totalLoss = 0;
                querySnapshot.forEach(doc => {
                    totalLoss += doc.data().amount;
                });
                totalLossElement.textContent = Math.abs(totalLoss).toFixed(2) + " €";
            });
            
            // Net balance is handled by the main balance
        };

        // Mise à jour du solde (ajout)
        updateBalanceButton.onclick = () => {
            processTransaction(false);
        };

        // Mise à jour du solde (soustraction)
        subtractBalanceButton.onclick = () => {
            processTransaction(true);
        };

        // Fonction pour traiter une transaction
        const processTransaction = (isSubtraction) => {
            let changeAmount = parseFloat(balanceChange.value);
            if (isNaN(changeAmount) || changeAmount <= 0) {
                alert("Veuillez entrer un montant valide positif.");
                return;
            }
            
            if (isSubtraction) {
                changeAmount = -changeAmount;
            }

            const userRef = db.collection("journals").doc(userId);
            
            db.runTransaction(transaction => {
                return transaction.get(userRef).then(doc => {
                    let newBalance = 0.00;
                    if (doc.exists) {
                        newBalance = doc.data().balance || 0.00;
                    }
                    newBalance += changeAmount;

                    transaction.set(userRef, { balance: newBalance }, { merge: true });

                    const transactionRef = userRef.collection("transactions").doc();
                    transaction.set(transactionRef, {
                        amount: changeAmount,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    return newBalance;
                });
            }).then(newBalance => {
                balanceElement.textContent = newBalance.toFixed(2);
                balanceChange.value = "";
                loadTransactionHistory(userId);
                calculateStats(userId);
            }).catch(error => {
                console.error("Erreur de transaction :", error);
                alert("Une erreur s'est produite lors de la mise à jour du solde.");
            });
        };

        // Rafraîchir le solde
        refreshBalance.onclick = () => {
            loadBalance(userId);
            loadTransactionHistory(userId);
            calculateStats(userId);
        };

        // Gestion de la pagination
        pageNext.onclick = () => {
            currentPage++;
            loadTransactionHistory(userId);
        };

        pagePrevious.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadTransactionHistory(userId);
            }
        };

        // Déconnexion de l'utilisateur
        logoutButton.onclick = () => {
            auth.signOut().then(() => {
                window.location.href = '/';
            });
        };
    </script>
</body>
</html>